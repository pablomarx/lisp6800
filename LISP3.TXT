 NAM LISP-STACK OPT PAG PAGOBEGAD EQU $06A0STKMIN EQU 50MINFRE EQU 20MRKBIT EQU 2*CAR EQU 0CDR EQU 2EOI EQU 4* LIB LISPLB* GLOBAL VECTORS ORG $0100EVAL RMB 3READ RMB 3PRINT RMB 3 RMB 3 JMP GETCEL JMP FRECEL JMP PUSHX JMP POPX JMP TOPXEVLATM RMB 3SETATM RMB 3LOOKUP RMB 3GNXTL RMB 3GFNXTL RMB 3LSTINI RMB 3LSTADD RMB 3LSTAD2 RMB 3LSTEND RMB 3LSTEN0 EQU POPXERREX RMB 3ATMINI RMB 3ISDTPR RMB 3ISATOM RMB 3GETC RMB 3NUMINV RMB 3NUMFRM RMB 3FRMNUM RMB 3PUTSYM RMB 3PUTC RMB 3ERRBRK RMB 3GETSYM RMB 3 JMP STKFRG JMP GCOL JMP PROPSHGETCAR RMB 3 JMP ISVARPRINR RMB 3 JMP PROPOP* ORG OBEGADSTKFRG STS XTMP2 LDAA XTMP2+1 CMPA #STKMIN BLS STKF2 RTS*STKF2 STX XTMP2 LDAA ENDPTR LDAB ENDPTR+1 BEQ STKF4 BSR BLKFRE STX ENDPTRSTKF4 DECA CMPA SPCPTR BLS STKFUL STAA ENDPTR STAA XTMP LDAA #250 STAA XTMP+1 LDX XTMP PULA STAA 0,X PULA STAA 1,X STS 4,X LDAA UNRAVA STAA 2,X LDAA UNRAVA+1 STAA 3,X TXS LDX XTMP2 RTS*STKFUL LDX #STKEMG JMP ERREX*UNRAVA FDB UNRAVL*UNRAVL STX XTMP2 TSX LDS 0,X STX XTMP LDAA XTMP CMPA ENDPTR BNE UNRFRE INCA STAA ENDPTRUNRVRT LDX XTMP2 RTS*UNRFRE CLRB BSR BLKFRE BRA UNRVRT*BLKFRE STAA XTMP SUBB #4 STAB XTMP+1 LDX XTMP BRA BLKF2BLKF1 STAA CDR,X STAB CDR+1,X LDX CDR,XBLKF2 SUBB #4 BCC BLKF1 LDAB FREPTR+1 STAB CDR+1,X LDAB FREPTR STAB CDR,X LDAB XTMP+1 STAB FREPTR+1 STAA FREPTR RTS*GETCEL LDX FREPTR BNE OLDGET LDAA ENDPTR+1 BNE GCL2* JSR GCOL LDAA GCFREE+1 CMPA #MINFRE BHS GETCEL LDAA GCFREE BNE GETCEL LDAA ENDPTR DECA CMPA SPCPTR BLS NOGCEL STAA ENDPTR LDAA ENDPTR+1GCL2 SUBA #4 STAA ENDPTR+1 LDX ENDPTR STX CELPTR BRA NEWGET*OLDGET STX CELPTR LDX CDR,X STX FREPTR LDX CELPTRNEWGET CLR 0,X CLR 1,X CLR 2,X CLR 3,X RTSNOGCEL LDX #NOGCMG JMP ERREX*PROPSH INC STKPTR+1PUSHX STX XTMP BSR GETCEL LDAA XTMP STAA CAR,X LDAA XTMP+1 STAA CAR+1,X LDAA STKPTR STAA CDR,X LDAA STKPTR+1 STAA CDR+1,X STX STKPTR LDX XTMP RTS*POPX LDX STKPTR BEQ POPXER LDAA CDR,X STAA STKPTR LDAA CDR+1,X ANDA #$FE STAA STKPTR+1 BSR FRECEL LDX CAR,X RTS*POPXER LDX #EOSTKM JMP ERREX*PROPOP EQU POPX*TOPX LDX STKPTR BEQ POPXER LDX CAR,X RTS*ISVAR JSR ISATOM BCS ISVNO BLE ISVNO CPX TATOM BEQ ISVNO CLC RTSISVNO SEC RTS*FRECEL LDAA FREPTR STAA CDR,X LDAA FREPTR+1 STAA CDR+1,X STX FREPTR RTS*GCOL BSR GCTRCE LDX ZERO STX FREPTR STX GCFREE STS GCTEMP CLR GCTEMP+1 LDX ENDPTRGCF1 CPX GCTEMP BNE GCF3 LDAA 254,X INC GCTEMP LDX GCTEMP STAA GCTEMP BRA GCF1*GCF3 CPX ENDMEM BEQ GCFDUN LDAA CDR+1,X BITA #MRKBIT BNE GCFCLR BSR FRECEL INC GCFREE+1 BNE GCFINX INC GCFREE BRA GCFINX*GCFCLR EORA #MRKBIT STAA CDR+1,X LDAA CAR+1,X EORA #MRKBIT STAA CAR+1,XGCFINX INX INX INX INX BRA GCF1*GCFDUN RTS*GCTRCE LDX ZERO STX DADPTR LDX XTMP STX GCTEMP LDAA STKPTR+1 RORA LDX STKPTR BCC GCT2*GCT1 STX XTMP2 LDX GCTEMP BSR GCTOBJ DEC XTMP2+1 LDX XTMP2*GCT2 BEQ GCT4GCT3 BSR GCTMRK BHI GCT3 BCS GCT1*GCT4 LDX SYMLST BSR GCTOBJ* LDX CUREVL BSR GCTOBJ LDX FORM BSR GCTOBJ RTS*GCTMRK LDAA CAR,X STAA GCTEMP LDAA CAR+1,X STAA GCTEMP+1 EORA #MRKBIT STAA CAR+1,X LDAA CDR+1,X ORAA #MRKBIT STAA CDR+1,X RORA LDX CDR,X DEX DEX RTS*GCTOBJ STX SONPTR BGT GCOGOGCTRET RTS*GCODAT DEX LDAA CDR+1,X*GCOCDD EORA #MRKBIT STAA DADPTR+1 LDAA CDR,X STAA DADPTR LDAA SONPTR STAA CDR,X LDAA SONPTR+1 STX SONPTR BCC GCOCD2 INC SONPTR+1*GCOCD2 ORAA #MRKBIT STAA CDR+1,X*GCODUN LDX DADPTR BEQ GCTRET LDAB DADPTR+1 RORB BCS GCODAT LDAA CDR+1,X BITA #MRKBIT BNE GCOCDD LDAB CAR+1,X STAB CDR+1,X LDAB SONPTR+1 ORAB #MRKBIT STAB CAR+1,X STAA SONPTR+1 LDAA CDR,X LDAB CAR,X STAB CDR,X LDAB SONPTR STAB CAR,X STAA SONPTR*GCOCA2 LDX SONPTR BLE GCODUNGCOGO LDAA SONPTR+1 RORA BCS GCOATM LDAB CAR+1,X BITB #MRKBIT BNE GCODUN LDAA CAR,X BLE GCOCAA STAB SONPTR+1 STAA SONPTR LDAA DADPTR STAA CAR,X LDAA DADPTR+1 ORAA #MRKBIT STAA CAR+1,X BRA GCOCA4*GCOCAA LDAA CDR+1,X BRA GCOCA3*GCOATM LDAA CDR+1-1,X BITA #MRKBIT BNE GCODUN DEX LDAB CAR+1,X*GCOCA3 EORB #MRKBIT STAB CAR+1,X LDAB CDR,X BLE GCOCD2 STAA SONPTR+1 STAB SONPTR LDAA DADPTR STAA CDR,X LDAA DADPTR+1 ORAA #MRKBIT STAA CDR+1,X BCC GCOCA4 INX*GCOCA4 STX DADPTR BRA GCOCA2*EOSTKM FCC 'STACK UNDERFLOW' FCB 4NOGCMG FCC 'NO MORE FREE SPACE' FCB 4STKEMG FCC 'NO ROOM FOR STACK' FCB 4*BEGADR EQU * END